#!/usr/bin/env bash

# Get newer images from https://hub.docker.com/_/jenkins/
docker pull jenkinsci/jenkins:2.0-rc-1

docker build -t jenkins-data -f Dockerfile-data .
docker build -t jenkins2 .
sleep 1

docker run --name=jenkins-data jenkins-data
docker run -p 8080:8080 -p 50000:50000 --name=jenkins-master --volumes-from=jenkins-data -d jenkins2

echo -n "Starting Jenkins server"
for i in {1..30}; do
  echo -n "."
  sleep 1
done
echo

echo "Getting initial Jenkins admin password and copying to the OSX clipboard... "
docker exec jenkins-master cat /var/jenkins_home/secrets/initialAdminPassword | pbcopy
pbpaste || echo "Failed to retrieve password"
sleep 1

read -n 1 -p "Press 'y' to open Jenkins GUI at http://$(docker-machine ip dockerhost):8080/, or any other key to end setup: "
if [[ $REPLY =~ ^[Yy]$ ]]; then
  open http://$(docker-machine ip dockerhost):8080/
fi
echo

echo "Initial setup complete, exiting."

